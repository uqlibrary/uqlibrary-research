<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">

<polymer-element name="uqlibrary-research-trending" layout center attributes="user">
  <template>
    <uqlibrary-api-academic-trending-publications id="api"></uqlibrary-api-academic-trending-publications>
    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">

    <div id="cards" vertical center-justified layout>
      <template repeat="{{card in cards}}">
        <paper-shadow class="card" z="1" hidden?="{{ !publications[card['type']] || publications[card['type']].length == 0}}">
        <div class="subhead cardSection cardTitle">{{card.title}} </div>
          <template repeat="{{ pub, index in publications[card['type']] }}">
            <div vertical layout>

                <div horizontal layout center class="hoverable">
                  <div class="new-title" flex>
                    <div vertical layout>
                      <div horizontal layout>
                        <div flex class="authors">{{pub.authors}}</div>
                        <div  class="year">{{pub.rek_date | showYear}}</div>
                      </div>
                      <div>{{pub.title}}</div>
                    </div>
                  </div>
                    <div class="num-cites border-left" self-stretch>
                      {{pub.count}}<span class="plus" hidden?="{{pub.difference == 0}}">+{{pub.difference | numberFormat}}</span>
                    </div>
                    <!--<div class="num-cites border-left" self-stretch>+{{pub.difference | numberFormat}}</div>-->
                 </div>
                </div>
                <hr class="thin" hidden?="{{index == publications[card['type']].length -1}}">
          </template>
        </paper-shadow>

      </template>

      <div class="card">
        <paper-shadow z="1">
          <div class="subhead cardSection cardTitle">Research guides</div>

          <div class="cardSection">
            <a href="http://guides.library.uq.edu.au/getting-published">
              <core-icon class="link" icon="description" aria-label=""></core-icon>
              Guide to Getting Published
            </a>
          </div>
          <div class="cardSection">
            <a href="https://www.library.uq.edu.au/research-support" target="_blank">
              <core-icon class="link" icon="arrow-forward" aria-label=""></core-icon>
              See all research support
            </a>
          </div>
        </paper-shadow>
      </div>
    </div>

  </template>

  <script>

    Polymer('uqlibrary-research-trending', {
      publications: [],
      user: null,

      cards: [
        {
          'type' : 'altmetric',
          'title' : 'Altmetric Score'
        },
        {
          'type' : 'thomson',
          'title' : 'Web of Science Citation Count'
        },
        {
          'type' : 'scopus',
          'title' : 'Scopus Citation Count'
        }
      ],

      created: function() {
      },

      ready: function() {
        var that = this;

        this.$.api.addEventListener('uqlibrary-api-academic-trending-publication', function(e) {
          that.publications = e.detail;
        });
      },

      userChanged: function(newValue) {

        if(this.user.hasOwnProperty('id')) {
          this.$.api.get({'username' : this.user.id});
        }
      },

      numberFormat: function(value) {
        return parseFloat(value).toFixed(0);
      },

      showYear: function(value) {
        var date = moment(value);
        if(date.isValid()) {
          return date.format('YYYY');
        }
        return value;
      }


    });

  </script>

</polymer-element>