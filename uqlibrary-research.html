<!--
Element providing an overview for student's courses

##### Example

    <uqlibrary-research></uqlibrary-research>

@element uqlibrary-research
@blurb Element providing an overview of a researcher
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-research
-->

<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">
<link rel="import" href="uqlibrary-research-trending.html">
<link rel="import" href="uqlibrary-research-metrics.html">

<polymer-element name="uqlibrary-research" layout center attributes="autoload">

  <template>

    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">

    <core-signals on-core-signal-transitioning-change="{{transitioningChangeHandler}}"></core-signals>

    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-authors-search id="autorsSearchApi" on-uqlibrary-api-authors-search-loaded="{{autosuggestLoaded}}"></uqlibrary-api-authors-search>

    <uqlibrary-ga id="ga" appName="Research"></uqlibrary-ga>

    <core-drawer-panel id="drawerPanel" class="drawer" drawerWidth="256px" responsiveWidth="768px">
      <core-header-panel drawer>
        <uqlibrary-menu account="{{user}}"></uqlibrary-menu>
      </core-header-panel>

      <core-header-panel main class="main">
          <uqlibrary-toolbar id="toolbar"
                  on-uqlibrary-toolbar-menu-clicked="{{toggleMenuDrawer}}"
                  on-uqlibrary-toolbar-search-submitted="{{performSearch}}"
                  on-uqlibrary-toolbar-link-clicked="{{appLinkClicked}}"
                  on-uqlibrary-toolbar-search-value-changed="{{loadAutosuggest}}"
                  appTitleLink="#"
                  appLinks='[{"label": "Clear search", "url": "#ClearSearch"}]'
                  searchPlaceholderText="Search for a researcher by username">
          </uqlibrary-toolbar>

        <div id="content">

          <paper-tabs id="tabs" selected="{{ selectedTab }}" on-core-select="{{ tabSelected }}">

            <paper-tab name="Trending" id="tabTrending" aria-label="My trending research">
              <div class="menu">
                <uqlibrary-a11y-link>
                  <div class="tabTitle" layout vertical center>Trending Publications</div>
                </uqlibrary-a11y-link>
              </div>
            </paper-tab>

            <paper-tab name="Metrics" id="tabMetrics" aria-label="My research metrics">
              <div class="menu">
                <uqlibrary-a11y-link>
                  <div class="tabTitle" layout vertical center>Metrics</div>
                </uqlibrary-a11y-link>
              </div>
            </paper-tab>


//   ____        _     _ _           _   _                   _____     _
//  |  _ \ _   _| |__ | (_) ___ __ _| |_(_) ___  _ __  ___  |_   _|_ _| |__
//  | |_) | | | | '_ \| | |/ __/ _` | __| |/ _ \| '_ \/ __|   | |/ _` | '_ \
//  |  __/| |_| | |_) | | | (__ (_| | |_| | (_) | | | \__ \   | | (_| | |_) |
//  |_|    \__,_|_.__/|_|_|\___\__,_|\__|_|\___/|_| |_|___/   |_|\__,_|_.__/
//
              <!--Publications tab not used yet - uncomment when needed-->

            <!--<paper-tab name="Publications" id="tabPublications" aria-label="My publications">-->
              <!--<div class="menu">-->
                <!--<uqlibrary-a11y-link>-->
                  <!--<div class="tabTitle" layout vertical center>Publications</div>-->
                <!--</uqlibrary-a11y-link>-->
              <!--</div>-->
            <!--</paper-tab>-->

          </paper-tabs>

          <core-animated-pages id="animatedPages" transitions="slide-from-right" block
                               selected="{{ selectedTab }}" valueattr="name"
                               on-core-animated-pages-transition-prepare="{{transitionPrepareHandler}}"
                               on-core-animated-pages-transition-end="{{transitionEndHandler}}">

            <section id="sectionTrending" name="Trending">
              <uqlibrary-research-trending id="trendingElement"
                                           on-uqlibrary-research-trending-loaded="{{trendingResearchLoaded}}">
              </uqlibrary-research-trending>
            </section>

            <section id="sectionMetrics" name="Metrics">
              <uqlibrary-research-metrics id="metricsElement">
              </uqlibrary-research-metrics>
            </section>

            <section id="sectionPublications" name="Publications">
              <div><h2>This is publications info</h2></div>
            </section>

          </core-animated-pages>

        </div>
      </core-header-panel>

    </core-drawer-panel>

  </template>

  <script>
    Polymer('uqlibrary-research', {

      // Accessibility issues fixes
      keyboardNavigationKeys: 'space enter',

      a11yKeyPressed: function(source, event) {
        if (source.path && source.path.length > 0 && source.path[0].target) {
          source.path[0].target.fire("tap");
        }
      },

      appTitle: 'My Research',
      autoload: true,
      selectedTab: 'Trending',
      transitioning: false,
      user: {},

      /**
       * Show/hide main menu
       * */
      togglePanel: function () {
        this.$.drawerPanel.togglePanel();
      },

      ready: function() {
        var that = this;
        this.$.toolbar.appTitle = this.appTitle;

        this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
          if (e.detail.hasSession) {
            if(e.detail.classes) {
              that.user = e.detail;

              that.$.trendingElement.user = that.user;
              that.$.trendingElement.isSearch = false;

              that.$.metricsElement.user = that.user;
              that.$.metricsElement.isSearch = false;
            }
          } else {
            // Not logged in
            that.$.account.login(window.location.href);
          }
        });

        if (this.autoload) {
          this.$.account.get();
        }
      },

      selectedTabChanged: function(oldValue, newValue) {
        if(oldValue && newValue) {
          this.$.ga.addEvent('Research tab changed', newValue);
        }
      },

      loadAutosuggest: function(event) {
        if(event.detail.value.length >= 2) {
          this.$.autorsSearchApi.get({ lookupName: event.detail.value });
        }
      },

      autosuggestLoaded: function(event) {
        var suggestions = [];
        if(event.detail.length > 0){
          event.detail.forEach(function(item) {
            suggestions.push( { text: item.title + ' ' + item.given_name + ' ' + item.family_name + ' ('+ item.username + ')', value: item.username } );
          });

          this.$.toolbar.fire('uqlibrary-toolbar-search-suggestions-loaded', { data: suggestions })
        }
      },

      performSearch: function(event){
        this.$.toolbar.deactivateSearch();

        //check if auto suggest was selected
        //TODO: replace with objs selected
        var userId = event.detail.searchTerm.replace(/.*\(|\)/gi, '');

        this.$.trendingElement.isSearch = true;
        this.$.trendingElement.user = { id: userId };

        this.$.metricsElement.isSearch = true;
        this.$.metricsElement.user = { id: userId };
      },

      appLinkClicked: function(e) {
        if (e.detail === '#ClearSearch') {
          this.$.toolbar.clearSearchForm();
          this.$.toolbar.appTitle = this.appTitle;

          this.$.trendingElement.isSearch = false;
          this.$.trendingElement.user = this.user;

          this.$.metricsElement.isSearch = false;
          this.$.metricsElement.user = this.user;
        }
      },

      trendingResearchLoaded: function(e) {
        if (this.$.trendingElement.isSearch) {
          if (e.detail && e.detail.author_details && e.detail.author_details.length > 0) {
            var author = e.detail.author_details[0];

            if (this.user.id == author.aut_org_username) {
              this.$.toolbar.appTitle = this.appTitle;
            }
            else {
              this.$.toolbar.appTitle =
                      author.aut_title + " " +
                      author.aut_fname + " " +
                      author.aut_lname + "'s Research";

            }
          } else if (this.$.toolbar.searchFieldValue) {
            this.$.toolbar.appTitle = "No Results Found";
          } else {
            this.$.toolbar.appTitle = this.appTitle;
          }
        }
      },

      transitioningChangeHandler: function(e) {
        if(e.detail.hasOwnProperty('transitioning'))
          this.transitioning = e.detail.transitioning;
      },

      transitionPrepareHandler: function() {
        this.transitioning = true;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      },

      transitionEndHandler: function() {
        this.transitioning = false;
        this.fire('core-signal', {name: "transitioning-change", data: {transitioning: this.transitioning}});
      }
    });
  </script>

</polymer-element>