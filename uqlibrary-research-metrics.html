<link rel="import" href="../uqlibrary-elements/0.5.4/lib/vulcanized.html">

<polymer-element name="uqlibrary-research-metrics" layout center attributes="user">
  <template>
    <uqlibrary-api-academic-hindex id="api"></uqlibrary-api-academic-hindex>
    <uqlibrary-api-academic-stats id="apiStats"></uqlibrary-api-academic-stats>

    <link rel="stylesheet" href="../uqlibrary-elements/resources/theme/element.css">

      <paper-shadow z="1" class="card"
                    hidden?="{{ hasHindexData || hasStatsData}}">
          <div class="cardSection">
              It looks like we don't have any publications that have any recorded citation counts yet.
          </div>
          <div class="cardSection caption">
              Your publications will appear here when someone else references or cites them.
              Your total score or citation count and the amount it's changed in the past year (Altmetrics) or month (Scopus & WoS) will be displayed.
          </div>
      </paper-shadow>

    <div class="card">



      <paper-shadow z="1">
        <div class="subhead cardSection cardTitle">My metrics</div>

          <a href="https://espace.library.uq.edu.au/{{user.id}}" target="_blank">
            <div class="text-center text-container hoverable">
                <span class="espace" id="publications">{{stats.id.count | zeroIfNone}}</span><span class="metric-text">eSpace Publications</span>
            </div>
          </a>

        <div horizontal layout class="border-top centre" id="wos-stats">

            <div horizontal layout center flex class="metrics-type hoverable">
                Web of Science
            </div>

          <div center-justified class="border-left type-cites">
            <div class="metrics-cites">{{hindex.hindex_incites | zeroIfNone}}</div>
            <div class="type-cites">h-index</div>
          </div>

          <div center-justified class="border-left papers">
            <div class="metrics-cites">{{stats.thomson_citation_count_i.count | zeroIfNone}}</div>
            <div class="type-cites">Papers</div>
          </div>

          <div center-justified class="border-left citations">
            <div class="metrics-cites">{{stats.thomson_citation_count_i.sum | zeroIfNone}}</div>
            <div class="type-cites">Citations</div>
          </div>

        </div>

        <div horizontal layout class="border-top centre" id="scopus-stats">

            <div horizontal layout center flex class="metrics-type  hoverable">
                Scopus
            </div>

          <div center-justified class="border-left type-cites">
            <div class="metrics-cites">{{hindex.hindex_scopus | zeroIfNone}}</div>
            <div class="type-cites">h-index</div>
          </div>

          <div center-justified class="border-left papers">
            <div class="metrics-cites">{{stats.scopus_citation_count_i.count | zeroIfNone}}</div>
            <div class="type-cites">Papers</div>
          </div>

          <div center-justified class="border-left citations">
            <div class="metrics-cites">{{stats.scopus_citation_count_i.sum | zeroIfNone}}</div>
            <div class="type-cites">Citations</div>
          </div>

        </div>

      </paper-shadow>
    </div>

    <div class="card">
      <paper-shadow z="1">
        <div class="subhead cardSection cardTitle">Research guides</div>

        <div class="cardSection">
          <a href="http://guides.library.uq.edu.au/research_impact/author-identifiers">
            <core-icon class="link" icon="assignment-ind" aria-label=""></core-icon>Guide to Author Identifiers
          </a>
        </div>
        <div class="cardSection">
          <a href="http://guides.library.uq.edu.au/research_impact" target="_blank">
            <core-icon class="link" icon="trending-up" aria-label=""></core-icon>Guide to Research Output & Impact
          </a>
        </div>
        <div class="cardSection">
          <a href="https://www.library.uq.edu.au/research-support" target="_blank">
            <core-icon class="link" icon="arrow-forward" aria-label=""></core-icon>See all research support
          </a>
        </div>
      </paper-shadow>
    </div>

  </template>

  <script>
    Polymer('uqlibrary-research-metrics', {
      user: {},

      created: function () {
      },

      userChanged: function (newValue) {
        if (this.user.hasOwnProperty('id')) {
          this.$.api.get({username: this.user.id});
          this.$.apiStats.get({username: this.user.id});
        }
      },

      ready: function () {
        var that = this;
        this.$.api.addEventListener('uqlibrary-api-academic-hindex-loaded', function (e) {
          that.hindex = e.detail;
          that.hasHindexData = !that.isEmptyHindexResults();

        });

        this.$.apiStats.addEventListener('uqlibrary-api-academic-stats-loaded', function (e) {
          that.stats = e.detail.stats.stats_fields;
          that.hasStatsData = !that.isEmptyStatsResults();
        });
      },

      zeroIfNone: function (value) {
        if (value == null) {
          return 0;
        }
        else {
          return value;
        }
      },

      isEmptyStatsResults: function () {
        return ((!this.stats.hasOwnProperty("id") || (this.stats.hasOwnProperty("id") && this.stats.id.count == 0))
               && (!this.stats.hasOwnProperty("thomson_citation_count_i")
                  || (this.stats.hasOwnProperty("thomson_citation_count_i")
                      && (this.stats.thomson_citation_count_i == null || (this.stats.thomson_citation_count_i.count == 0 && this.stats.thomson_citation_count_i.sum == 0))))

               && (!this.stats.hasOwnProperty("scopus_citation_count_i")
                  || (this.stats.hasOwnProperty("scopus_citation_count_i")
                      && (this.stats.scopus_citation_count_i == null || (this.stats.scopus_citation_count_i.count == 0 && this.stats.scopus_citation_count_i.sum == 0)))));
      },

      isEmptyHindexResults: function () {
        return (!this.hindex.hasOwnProperty("hindex_incites") || (this.hindex.hasOwnProperty("hindex_incites") && this.hindex.hindex_incites == 0))
          && (!this.hindex.hasOwnProperty("hindex_scopus") || (this.hindex.hasOwnProperty("hindex_scopus") && this.hindex.hindex_scopus == 0));
      }

    });
  </script>

</polymer-element>
